name: Nightly Deployment Workflow

on:
  schedule:
    - cron: "0 0 * * *"  # Runs nightly at midnight UTC
  workflow_dispatch:

jobs:
  nightly-deployment:
    runs-on: ubuntu-latest

    env:
      AWS_REGION: us-east-1
      IMAGE_TAG: latest
      SOURCE_REPO: https://github.com/satya-sh/DevOps_Midterm_Source.git

    steps:
      # 1) Check out this (Infra) repo
      - name: Checkout Infra Repo
        uses: actions/checkout@v4

      # 2) Check out your Source Repo
      - name: Checkout Source Repo
        uses: actions/checkout@v4
        with:
          repository: "satya-sh/DevOps_Midterm_Source"
          path: "source"  # Directory where the repo will be cloned

      # 3) Build and Start Containers Using Docker Compose (optional local test)
      - name: Build and Start Containers Using Docker Compose
        run: |
          cd source
          # Create a .env file from GitHub Secrets
          cat <<EOF > .env
          DB_HOST=${{ secrets.RDS_ENDPOINT }}
          DB_USER=${{ secrets.RDS_USERNAME }}
          DB_PASSWORD=${{ secrets.RDS_PASSWORD }}
          DB_NAME=${{ secrets.RDS_DBNAME }}
          DB_PORT=3306
          EOF
          # We pass --env-file .env so docker compose can read those variables
          docker compose -f docker-compose.prod.yml --env-file .env up -d --build
          sleep 20  # wait for containers to spin up
